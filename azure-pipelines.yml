# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- master


pool:
  vmImage: ubuntu-latest

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '10.x'
  displayName: 'Install Node.js'

- script: |
    npm install
    npm run build
  displayName: 'npm install and build'


- script: |
    npx oval validate -p api_auth.yml | echo "ok"


- script: |
    # By convention, we expose api specifications using files
    #  in form api_<api-name>.yaml in the root of this project
    valid=1

    echo $(ls api_*.yaml)

    for apispec in $(ls api_*.yaml); do

      echo $apispec

      echo "validating $apispec"
      npx oval validate -p $apispec
      result=$?
      if [ ! $result = 0 ]; then
        valid=0
        echo "$apispec failed with code $result"
      fi
    done
    [[ $valid = 1 ]] && exit 0 || exit 1
    displayName: 'Validate API specifications'
